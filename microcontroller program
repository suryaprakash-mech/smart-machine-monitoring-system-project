#include <WiFi.h>
#include <WiFiClientSecure.h>
#include <PubSubClient.h>
#include <DHT.h>

// WiFi Credentials
const char* ssid = "Your_WiFi_Name";
const char* password = "Your_WiFi_Password";

// AWS IoT Credentials
const char* mqtt_server = "your-aws-endpoint.amazonaws.com";
const char* mqtt_topic = "machine/data";

// AWS IoT Certificates
const char* AWS_CERT_CA = R"EOF(
-----BEGIN CERTIFICATE-----
YOUR_ROOT_CA_CERTIFICATE_HERE
-----END CERTIFICATE-----
)EOF";

const char* AWS_CERT_CRT = R"EOF(
-----BEGIN CERTIFICATE-----
YOUR_DEVICE_CERTIFICATE_HERE
-----END CERTIFICATE-----
)EOF";

const char* AWS_CERT_PRIVATE = R"EOF(
-----BEGIN RSA PRIVATE KEY-----
YOUR_PRIVATE_KEY_HERE
-----END RSA PRIVATE KEY-----
)EOF";

// Secure WiFi Client for SSL/TLS
WiFiClientSecure espClient;
PubSubClient client(espClient);

// Sensor Pins
#define IR_SENSOR 4
#define VIBRATION_SENSOR 5
#define DHTPIN 2
#define DHTTYPE DHT11

DHT dht(DHTPIN, DHTTYPE);

void setup() {
  Serial.begin(115200);
  
  pinMode(IR_SENSOR, INPUT);
  pinMode(VIBRATION_SENSOR, INPUT);
  
  dht.begin();

  // Connect to WiFi
  connectWiFi();
  
  // Configure AWS IoT Certificates
  espClient.setCACert(AWS_CERT_CA);
  espClient.setCertificate(AWS_CERT_CRT);
  espClient.setPrivateKey(AWS_CERT_PRIVATE);

  client.setServer(mqtt_server, 8883);
}

void connectWiFi() {
  Serial.print("WiFi Connecting...");
  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) {
    delay(1000);
    Serial.print(".");
  }
  Serial.println("Connected!");
}

void sendData() {
  int rpm = digitalRead(IR_SENSOR);
  int vibration = digitalRead(VIBRATION_SENSOR);
  float temperature = dht.readTemperature();
  
  String payload = "{";
  payload += "\"rpm\": " + String(rpm) + ",";
  payload += "\"vibration\": " + String(vibration) + ",";
  payload += "\"temperature\": " + String(temperature);
  payload += "}";
  
  Serial.println("Sending Data: " + payload);
  client.publish(mqtt_topic, payload.c_str());
}

void loop() {
  if (!client.connected()) {
    connectWiFi();
  }
  client.loop();
  
  sendData();
  delay(5000); // Send data every 5 seconds
}
